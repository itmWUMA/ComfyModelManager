# ComfyModelManager 项目提案

## 1. 项目概述

ComfyModelManager 是一个独立的桌面应用程序，用于管理 ComfyUI 的模型文件。提供模型分类浏览、信息展示（预览图、README）、从 Hugging Face 下载模型等功能。

## 2. 核心功能

### 2.1 模型分类管理

- 按**模型类型**和**基底模型**两个维度进行分类管理
- 支持的模型类型：Checkpoint、LoRA、VAE、ControlNet、CLIP、Upscaler、Embedding
- 支持的基底模型：SD 1.5、SDXL、FLUX、SD 3.x、Kolors、HunyuanDiT
- 基底模型列表可扩展，后续通过配置文件添加新的基底模型
- 扫描 ComfyUI 模型目录，自动发现并列出已有模型文件

### 2.2 模型信息展示

- 展示模型预览图（用户手动添加）
- 展示模型关联的 README 文件内容（从 HF 下载）
- 展示模型基本信息：文件名、文件大小、所属类型、基底模型分类

### 2.3 Hugging Face 模型下载

- 用户输入 HF 的 `repo_id` 和目标文件名，下载对应模型文件
- 同时下载该仓库的 README.md 文件
- 模型文件下载到 ComfyUI 模型目录对应位置，README 存储到应用数据目录
- 实时展示下载进度（进度条、下载速度、已下载/总大小）

## 3. 技术栈

| 组件 | 选型 | 说明 |
|------|------|------|
| 语言 | Python 3.10+ | 主要开发语言 |
| GUI 框架 | CustomTkinter | 现代化 Tkinter 封装，轻量且美观 |
| HF 下载 | huggingface_hub | 官方 Python SDK，支持文件下载 |
| 配置存储 | JSON 文件 | 存储应用配置和模型元数据 |
| 打包分发 | PyInstaller | 打包为独立可执行文件 |

## 4. 目录与存储设计

### 4.1 ComfyUI 模型目录结构（用户配置）

模型文件按 `类型/基底模型/文件` 的结构存储在用户配置的 ComfyUI 模型目录下：

```
<comfyui_models_dir>/
├── checkpoints/
│   ├── SD1.5/
│   │   └── v1-5-pruned.safetensors
│   ├── SDXL/
│   │   └── sd_xl_base_1.0.safetensors
│   └── FLUX/
│       └── flux1-dev.safetensors
├── loras/
│   ├── SD1.5/
│   └── SDXL/
├── vae/
├── controlnet/
├── clip/
├── upscaler/
└── embedding/
```

### 4.2 应用数据目录结构

README、预览图等附属文件存储在应用数据目录下，与模型文件分离：

```
<app_data_dir>/
├── config.json              # 应用配置文件
├── readmes/
│   └── <repo_id_hash>/      # 按 repo_id 哈希组织
│       └── README.md
└── previews/
    └── <model_hash>.png     # 按模型文件哈希命名
```

### 4.3 配置文件结构 (config.json)

```json
{
  "comfyui_models_dir": "D:/ComfyUI/models",
  "app_data_dir": "./data",
  "hf_token": "",
  "model_types": [
    {"id": "checkpoints", "label": "Checkpoint"},
    {"id": "loras", "label": "LoRA"},
    {"id": "vae", "label": "VAE"},
    {"id": "controlnet", "label": "ControlNet"},
    {"id": "clip", "label": "CLIP"},
    {"id": "upscaler", "label": "Upscaler"},
    {"id": "embedding", "label": "Embedding"}
  ],
  "base_models": ["SD 1.5", "SDXL", "FLUX", "SD 3.x", "Kolors", "HunyuanDiT"],
  "models_metadata": {
    "<model_file_relative_path>": {
      "repo_id": "stabilityai/stable-diffusion-xl-base-1.0",
      "filename": "sd_xl_base_1.0.safetensors",
      "preview": "previews/abc123.png",
      "readme": "readmes/abc123/README.md",
      "added_at": "2025-01-01T00:00:00"
    }
  }
}
```

## 5. 界面设计

### 5.1 主界面布局

```
+---------------------------------------------------------------+
|  ComfyModelManager                                    [设置]   |
+----------+----------------------------------------------------+
|          |  [SD 1.5] [SDXL] [FLUX] [SD 3.x] [Kolors] [...]   |
| 模型类型  +----------------------------------------------------+
|          |                                                     |
| Checkpoint|  +----------+  +----------+  +----------+          |
| LoRA     |  | 预览图    |  | 预览图    |  | 预览图    |          |
| VAE      |  | 模型名称  |  | 模型名称  |  | 模型名称  |          |
| ControlNet| | 文件大小  |  | 文件大小  |  | 文件大小  |          |
| CLIP     |  +----------+  +----------+  +----------+          |
| Upscaler |                                                     |
| Embedding|  +----------+  +----------+                         |
|          |  | 预览图    |  | 预览图    |                         |
| -------- |  | 模型名称  |  | 模型名称  |                         |
| [下载模型]|  | 文件大小  |  | 文件大小  |                         |
|          |  +----------+  +----------+                         |
+----------+----------------------------------------------------+
```

- 左侧边栏：模型类型列表（纵向导航）+ 下载入口按钮
- 顶部标签栏：基底模型筛选（横向标签切换）
- 主内容区：模型卡片网格展示

### 5.2 模型详情弹窗

点击模型卡片后弹出详情窗口：

- 预览图大图展示
- 模型文件信息（文件名、大小、路径）
- README 内容渲染展示
- 操作按钮：添加/更换预览图、打开文件所在目录、删除模型

### 5.3 下载模型弹窗

- 输入框：repo_id（如 `stabilityai/stable-diffusion-xl-base-1.0`）
- 输入框：文件名（如 `sd_xl_base_1.0.safetensors`）
- 下拉框：选择模型类型
- 下拉框：选择基底模型
- 下载进度条：显示进度百分比、下载速度、已下载/总大小
- 下载按钮 / 取消按钮

### 5.4 设置页面

- ComfyUI 模型目录路径配置（文件夹选择器）
- 应用数据目录路径配置
- Hugging Face Token 配置（用于下载需要授权的模型）

## 6. 项目结构

```
ComfyModelManager/
├── main.py                  # 应用入口
├── requirements.txt         # Python 依赖
├── README.md
├── 提案.md
├── src/
│   ├── __init__.py
│   ├── app.py               # 应用主窗口
│   ├── config.py            # 配置管理
│   ├── models/
│   │   ├── __init__.py
│   │   └── model_scanner.py # 模型目录扫描与元数据管理
│   ├── services/
│   │   ├── __init__.py
│   │   └── hf_downloader.py # Hugging Face 下载服务
│   ├── ui/
│   │   ├── __init__.py
│   │   ├── sidebar.py       # 左侧边栏（类型导航）
│   │   ├── topbar.py        # 顶部标签栏（基底模型筛选）
│   │   ├── model_grid.py    # 模型卡片网格
│   │   ├── model_card.py    # 单个模型卡片组件
│   │   ├── model_detail.py  # 模型详情弹窗
│   │   ├── download_dialog.py # 下载模型弹窗
│   │   └── settings_dialog.py # 设置弹窗
│   └── utils/
│       ├── __init__.py
│       └── file_utils.py    # 文件操作工具函数
└── data/                    # 默认应用数据目录
    ├── config.json
    ├── readmes/
    └── previews/
```

## 7. 关键流程

### 7.1 启动流程

1. 读取 config.json，若不存在则创建默认配置
2. 检查 ComfyUI 模型目录是否已配置且有效
3. 若未配置，弹出设置页面引导用户配置
4. 扫描模型目录，构建模型列表
5. 渲染主界面

### 7.2 模型下载流程

1. 用户点击"下载模型"，弹出下载弹窗
2. 用户输入 repo_id、文件名，选择模型类型和基底模型
3. 点击下载，后台线程执行：
   - 通过 `huggingface_hub.hf_hub_download()` 下载模型文件到目标目录
   - 通过 `huggingface_hub.hf_hub_download()` 下载 README.md 到应用数据目录
   - 实时回调更新下载进度条
4. 下载完成后更新 config.json 中的模型元数据
5. 刷新主界面模型列表

### 7.3 模型扫描流程

1. 遍历 ComfyUI 模型目录下各类型子目录
2. 对每个类型目录，遍历基底模型子目录
3. 识别模型文件（.safetensors、.ckpt、.pt、.pth、.bin）
4. 与 config.json 中的元数据进行匹配关联
5. 构建完整的模型信息列表

## 8. 依赖清单

```
customtkinter>=5.2.0
huggingface_hub>=0.20.0
Pillow>=10.0.0              # 图片处理（预览图展示）
```

## 9. 开发计划

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| P0 | 项目骨架搭建、配置管理、设置页面 | 高 |
| P1 | 模型目录扫描、主界面模型列表展示 | 高 |
| P2 | HF 模型下载（含进度展示） | 高 |
| P3 | 模型详情弹窗、README 展示 | 中 |
| P4 | 预览图管理（手动添加/展示） | 中 |
| P5 | PyInstaller 打包分发 | 低 |

## 10. 后续可扩展方向

- 支持 CivitAI 模型下载
- 模型搜索/过滤功能
- 批量下载
- 断点续传
- 模型文件完整性校验（SHA256）
- 自动从 HF 获取预览图
- 多语言支持
